---
title: "Session R: Correlation and Regression"
subtitle: "Denis Mongin et David Munoz Tord"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    includes:
    code_folding: "show"
    toc: true
    toc_float: true
    number_sections: false
---


# Setup

<!-- #for course -->

 <!-- Pearson's correlation coefficient (r). Or in other words: R is a correlation coefficient that measures the strength of the relationship between two variables, as well as the direction on a scatterplot. The value of r is always between a negative one and a positive one (-1 and a +1) -->
 

 <!-- Linear regression is a regression model that uses a straight line to describe the relationship between variables. It finds the line of best fit through your data by searching for the value of the regression coefficient(s) that minimizes the total error of the model. -->

## Start up  - Folder structure

Create a folder

Inside the folder named "Stats_2022" (or whatever you named it)  create a folder named "Session_6" (or whatever similar to your liking)

And inside this one create a folder names "data" (here I really suggest you call it "data")

### Download dataset

- session6_diet.xls
- session6_eggs.xls

And save it into your "data" folder.


### Create an .Rproject 

Within RStudio go into Files -> New Project

Choose: Existing Project and browser the "Session_6" folder you just created (or whatever you named it)

This will reload RStudio, don't worry


### Load libraries

```{r, message=FALSE, warning=FALSE}
#load required packages
library(dplyr) # to wrangle dats
library(tidyr) # to tidy the data
library(readxl) # to read the files
library(here) # to find files
library(ggplot2)


#these are just Rmarkdown visual options
knitr::opts_chunk$set(message=F, warning=F, comment=NA) 


```

Know where you are !

```{r}
#here() #from the here packages is a neat magic trick that will find where you files are 
#given that you are in a .Rproject, type help(here) for more info

```

## Read the data

```{r}

df_diet <- read_xls(here("data", "session6_diet.xls")) #read the data
#you can also just read it manually
#il18 <- read_xls("C:/Users/david/Documents/cours_stat/session6_diet.xls") # but this get annoying and buggy very fast
df_eggs <- read_xls(here("data", "session6_eggs.xls"))


```


Eggs is for the Platorchestia platensis example, and diet is the weight loss for subject ongoing a diet. 

We will use the eggs data for correlations, and the diet one for linear regression.


# Correlation with the Eggs Data


Check out the column names and data

```{r}
head(df_eggs)
```

##  Visulize the data

Make a plot of weigh in function of number of eggs:


```{r}

#hint: ggplot(data, aes(...)) + geom_point()
#hint2: assign your plot to an object, e.g. scatter <- ggplot(data, aes(...)) + geom_point()

scatter <- ggplot(data = df_eggs, aes(x = NbEggs, y = weight)) +
  geom_point()

scatter 

```

Inspect the data, is there anything that you should look for when doing correlations ? Is there any "problem" or can we continue ?



## Test the Correlation

Now estimate the correlation between the number of eggs and their weight

```{r}
#hint: use cor.test(data$x, data$y)

cor.test(df_eggs$weight, df_eggs$NbEggs)

```
Now run this chunk and read a bit the cor.test documentation

```{r}

?cor.test

```


Finally try to compute the Pearson and Spearman correlation of the same previous variables

```{r}
#hint: use cor.test(data$x, data$y, method = "..") 
cor.test(df_eggs$weight, df_eggs$NbEggs, method = "spearman")
```

Try to explain the different results with your neighbor.

## Linear regression with the Diet Data 



Check out the column names and data

```{r}
head(df_diet)
```



## linear regression


- do a linear regression predicting the number of eggs in funciton of the weight using `lm()` 

```{r}
fit <- lm(formula = NbEggs ~ weight,
          data = df_eggs)
```



```{r,fig.height=8,fig.width=6}
library(performance)
check_model(fit)
```


- inspect the coefficient using `summary()`

```{r}
summary(fit)
```

$$ y = a\times x + b $$

```{r}
plouf <- summary(fit)
plouf$coefficients

library(broom)
tidy(fit)
```



- What do the coefficients mean ? 
- could you predict the Number of eggs of a 15 g Platorchestia ?
- Extra: plot the prediction

```{r}
predict(fit)
```
```{r}
predict(fit,
        newdata = data.frame(weight = c(0:100)))
```


```{r}
df_eggs$predict <- predict(fit)

ggplot(df_eggs)+
  geom_point(aes(weight,NbEggs),size = 2)+
  geom_line(aes(weight,predict),color = "red")+
  theme_bw()
```

base R:

```{r}
plot(df_eggs$weight,df_eggs$NbEggs)
lines(df_eggs$weight,df_eggs$predict,col = 2)
```


# diet


```{r}
df_diet
```

## plot

represent the relationship between the weight loss `Weight.Diff` and `Age`, `height`, and `pre.weight`

```{r}
plot(df_diet$Weight.Diff,df_diet$Age)
```
etc. ggplot:

```{r}
ggplot(df_diet)+
  geom_point(aes(Weight.Diff,Age))
```

```{r}
df_diet %>% 
  pivot_longer(cols = c("Age", "Height", "pre.weight"),names_to = "variable") %>%
  ggplot(aes(Weight.Diff,value))+
  geom_point()+
  facet_wrap(~variable,scales = "free")
                 
```


## correlations

test the correlations between `Weight.Diff` and the other variables

```{r}
cor.test(df_diet$Weight.Diff,
         df_diet$Height)
```

```{r}
df_diet$Weight.Diff
```


```{r}
cor.test(-df_diet$Weight.Diff,df_diet$pre.weight)
```

```{r}
cor.test(df_diet$Weight.Diff,df_diet$Age)
```

## regression

- perform the regression `Weight.Diff` in function of the weight before pre.weight, and interpret the result.


```{r}
lm(Weight.Diff ~ pre.weight,data = df_diet) %>% 
  summary()
```

```{r}
lm(Weight.Diff ~ pre.weight + Age + as.factor(Gender),data = df_diet) %>% 
  summary()
```
```{r}
lm(Weight.Diff ~  Age,data = df_diet) %>% 
  summary()
```

Other tools for regression (among a lot): 
- `nls()` for non linear regression; 
- `lmer()` for mixed effect models; 
- `brms` for bayesian regressions.
- {lavaan} for structural equation modeling
- {geepack} and `gee` for generalised estimating equations

Machine learning:

- https://keras.rstudio.com/
- https://www.tidymodels.org/
- https://docs.h2o.ai/h2o/latest-stable/h2o-docs/data-science.html#supervised


